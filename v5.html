<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Pharma LIMS v7.0 | Dr. Daoud</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #0f172a; --accent: #0284c7; --success: #10b981; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        aside { width: 280px; background: var(--primary); color: white; padding: 25px; display: flex; flex-direction: column; }
        main { flex: 1; overflow-y: auto; padding: 30px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin-bottom: 25px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.3s; }
        select:focus, input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
        .test-box { background: #f0f9ff; padding: 20px; border-radius: 12px; border: 1px solid #bae6fd; }
        .btn-add { background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 800; width: 100%; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f1f5f9; padding: 15px; text-align: right; font-size: 12px; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .pass { background: #dcfce7; color: #166534; }
        .oos { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <aside>
        <div style="text-align: center; border-bottom: 1px solid #334155; padding-bottom: 20px; margin-bottom: 20px;">
            <i data-lucide="microscope" style="width: 45px; height: 45px; color: var(--accent);"></i>
            <h2 style="font-size: 18px; margin: 10px 0;">مختبر د. داود</h2>
            <p style="font-size: 11px; color: #94a3b8;">BP 2025 Smart System</p>
        </div>
        <div style="font-size: 14px; opacity: 0.8;"><i data-lucide="shield-check"></i> نظام إدارة الجودة v7.0</div>
    </aside>

    <main>
        <div class="card">
            <h3 style="margin-top:0;"><i data-lucide="plus-circle"></i> إدخال بيانات التشغيلة</h3>
            <div class="grid">
                <div>
                    <label>القسم (Category)</label>
                    <select id="cat" onchange="loadProducts()">
                        <option value="">-- اختر --</option>
                        <option value="RM">مواد فعالة (API)</option>
                        <option value="EXC">مواد مسوغة (Excipients)</option>
                        <option value="FP">منتج نهائي (Finished)</option>
                        <option value="MIC">مايكروبيولوجي (Micro)</option>
                    </select>
                </div>
                <div>
                    <label>المادة (Product)</label>
                    <select id="prod" onchange="loadTests()"></select>
                </div>
                <div>
                    <label>التشغيلة (Batch No.)</label>
                    <input type="text" id="bn" placeholder="Ex: BN990">
                </div>
            </div>

            <div class="grid">
                <div>
                    <label>المصنع (Manufacturer)</label>
                    <input type="text" id="fac" placeholder="اسم المصنع">
                </div>
                <div>
                    <label>تاريخ الإنتاج</label>
                    <input type="date" id="mfg">
                </div>
                <div>
                    <label>تاريخ الانتهاء</label>
                    <input type="date" id="exp">
                </div>
            </div>

            <div class="test-box" id="testArea" style="display:none;">
                <label style="color:var(--accent)">الاختبارات المقررة حسب المواصفة:</label>
                <div class="grid" style="margin-bottom:0; align-items: flex-end;">
                    <div>
                        <label>نوع التحليل</label>
                        <select id="testName"></select>
                    </div>
                    <div>
                        <label>النتيجة المقاسة</label>
                        <input type="number" id="testVal" step="0.001">
                    </div>
                    <div>
                        <button class="btn-add" onclick="saveData()">حفظ وإصدار شهادة</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3><i data-lucide="list"></i> سجل الإفراج النهائي</h3>
            <table>
                <thead>
                    <tr>
                        <th>المادة</th>
                        <th>التشغيلة</th>
                        <th>المصنع</th>
                        <th>Mfg / Exp</th>
                        <th>الاختبار</th>
                        <th>النتيجة</th>
                        <th>الحالة</th>
                        <th>COA</th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // قاعدة البيانات المحدثة بناءً على ملفاتك (BP 2025)
        const db = {
            "RM": {
                "Paracetamol BP": [{t:"Assay (%)", min:99.0, max:101.0}, {t:"LOD (%)", min:0, max:0.5}],
                "Aspirin BP": [{t:"Assay (%)", min:99.5, max:101.0}, {t:"Sulfated Ash (%)", min:0, max:0.1}],
                "Diclofenac Potassium": [{t:"Assay (%)", min:99.0, max:101.0}, {t:"LOD (%)", min:0, max:0.5}]
            },
            "EXC": {
                "Magnesium Stearate": [{t:"Mg Content (%)", min:4.0, max:5.0}, {t:"Acid Value", min:195, max:210}],
                "Maize Starch": [{t:"pH", min:4.0, max:7.0}, {t:"LOD (%)", min:0, max:15.0}],
                "Sodium Bicarbonate": [{t:"Assay (%)", min:99.0, max:101.0}, {t:"pH", min:0, max:8.6}]
            },
            "FP": {
                "Aspirin 75mg Tab": [{t:"Assay (%)", min:95.0, max:105.0}, {t:"Dissolution (%)", min:70, max:100}],
                "Ibuprofen 400mg Tab": [{t:"Hardness (N)", min:80, max:150}, {t:"Disintegration", min:1, max:15}]
            },
            "MIC": {
                "Micro-Finished Products": [{t:"TAMC (CFU/g)", min:0, max:1000}, {t:"TYMC (CFU/g)", min:0, max:100}],
                "Micro-Purified Water": [{t:"Total Bacteria", min:0, max:100}]
            }
        };

        function loadProducts() {
            const c = document.getElementById('cat').value;
            const pSel = document.getElementById('prod');
            pSel.innerHTML = '<option value="">-- اختر المادة --</option>';
            if(c && db[c]) {
                Object.keys(db[c]).forEach(p => pSel.add(new Option(p, p)));
                document.getElementById('testArea').style.display = 'block';
            } else {
                document.getElementById('testArea').style.display = 'none';
            }
            loadTests();
        }

        function loadTests() {
            const c = document.getElementById('cat').value;
            const p = document.getElementById('prod').value;
            const tSel = document.getElementById('testName');
            tSel.innerHTML = '';
            if(p && db[c][p]) {
                db[c][p].forEach((test, i) => tSel.add(new Option(`${test.t} [${test.min}-${test.max}]`, i)));
            }
        }

        let logs = [];

        function saveData() {
            const c = document.getElementById('cat').value;
            const p = document.getElementById('prod').value;
            const tIdx = document.getElementById('testName').value;
            const val = parseFloat(document.getElementById('testVal').value);
            const bn = document.getElementById('bn').value;
            const exp = document.getElementById('exp').value;
            const mfg = document.getElementById('mfg').value;
            const fac = document.getElementById('fac').value;

            if(!bn || !exp || isNaN(val)) return alert("يرجى إكمال بيانات التشغيلة والنتيجة وتاريخ الانتهاء");

            const spec = db[c][p][tIdx];
            const isPass = val >= spec.min && val <= spec.max;
            
            const entry = { p, bn, fac, mfg, exp, test: spec.t, val, limit: `${spec.min}-${spec.max}`, status: isPass ? 'PASS' : 'OOS' };
            logs.unshift(entry);
            render();
        }

        function render() {
            document.getElementById('logBody').innerHTML = logs.map(l => `
                <tr>
                    <td><b>${l.p}</b></td>
                    <td>${l.bn}</td>
                    <td>${l.fac}</td>
                    <td><small>P: ${l.mfg}<br>E: ${l.exp}</small></td>
                    <td>${l.test}</td>
                    <td><b>${l.val}</b></td>
                    <td><span class="badge ${l.status.toLowerCase()}">${l.status}</span></td>
                    <td><button onclick="window.print()" style="cursor:pointer">PDF</button></td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>