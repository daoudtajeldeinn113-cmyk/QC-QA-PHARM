<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LIMS v11.1 | GMP Quality Suite</title>
    <style>
        :root { --pass: #10b981; --fail: #ef4444; --primary: #1e293b; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #334155; }
        
        /* Dashboard & GMP Controls */
        .gmp-nav { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .gmp-status { font-size: 12px; background: #334155; padding: 5px 15px; border-radius: 4px; border: 1px solid #475569; }
        
        .container { max-width: 1100px; margin: 20px auto; padding: 20px; }
        .section-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        h3 { border-bottom: 2px solid var(--bg); padding-bottom: 10px; color: var(--primary); font-size: 16px; }
        .grid-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; color: #64748b; }
        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; }

        /* Test Tables Layout */
        .test-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .test-table th { background: #f8fafc; text-align: left; padding: 10px; font-size: 12px; border-bottom: 2px solid #e2e8f0; }
        .test-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        
        .res-input { width: 100%; padding: 5px; border: 1px solid #ccc; font-weight: bold; }
        .pass { background: #dcfce7 !important; border-color: var(--pass); }
        .fail { background: #fee2e2 !important; border-color: var(--fail); }

        /* Print Layout (The Official COA) */
        #coa-print { display: none; }
        @media print {
            .no-print { display: none !important; }
            #coa-print { display: block !important; padding: 20px; background: white; font-family: 'Times New Roman', serif; }
            .coa-header { display: flex; justify-content: space-between; border-bottom: 2px solid black; padding-bottom: 10px; }
            .coa-title { text-align: center; border: 1px solid black; padding: 5px; margin: 15px 0; font-weight: bold; background: #eee !important; }
            .info-box { display: flex; justify-content: space-between; margin-bottom: 15px; }
            .info-table { width: 48%; border-collapse: collapse; font-size: 12px; }
            .info-table td { border: 1px solid black; padding: 4px; }
            .results-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
            .results-table th, .results-table td { border: 1px solid black; padding: 6px; text-align: left; }
            .footer-sig { margin-top: 40px; display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; font-size: 11px; }
        }
    </style>
</head>
<body>

<div class="gmp-nav no-print">
    <div>
        <strong>SCI LIMS Suite v11.1</strong> | 
        <span class="gmp-status">GDP COMPLIANT MODE</span>
    </div>
    <div style="display:flex; gap:10px;">
        <select id="docMode" onchange="switchMode()">
            <option value="FP">Finished Product (Aspirin/Paramol)</option>
            <option value="RM">Raw Material (MCC/API)</option>
        </select>
        <button onclick="window.print()" style="background:#0ea5e9; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">Release COA</button>
    </div>
</div>

<div class="container no-print">
    <div class="section-card">
        <h3>1. Documentation Header (General Information)</h3>
        <div class="grid-inputs">
            <div class="field"><label>Product Name</label><input type="text" id="in_name" oninput="sync()"></div>
            <div class="field"><label>Batch No.</label><input type="text" id="in_batch" oninput="sync()"></div>
            <div class="field"><label>A.R. Number</label><input type="text" id="in_ar" oninput="sync()"></div>
            <div class="field"><label>Specification</label>
                <select id="in_spec" onchange="sync()">
                    <option value="BP 2025">BP 2025</option>
                    <option value="USP 44">USP 44</option>
                    <option value="In-House">In-House</option>
                </select>
            </div>
            <div class="field"><label>Mfg. Date</label><input type="text" id="in_mfg" oninput="sync()"></div>
            <div class="field"><label>Exp. Date</label><input type="text" id="in_exp" oninput="sync()"></div>
            <div class="field fp-only"><label>Strength</label><input type="text" id="in_str" oninput="sync()"></div>
            <div class="field fp-only"><label>Pack Size</label><input type="text" id="in_pack" oninput="sync()"></div>
        </div>
    </div>

    <div class="section-card">
        <h3>2. Laboratory Analysis (Chemical & Physical)</h3>
        <table class="test-table">
            <thead>
                <tr><th>Parameter</th><th>Specification</th><th>Result</th><th>Status</th></tr>
            </thead>
            <tbody id="chemBody"></tbody>
        </table>
    </div>

    <div class="section-card">
        <h3>3. Microbiology Control</h3>
        <table class="test-table">
            <thead>
                <tr><th>Test</th><th>Limit</th><th>Result</th><th>Status</th></tr>
            </thead>
            <tbody id="microBody"></tbody>
        </table>
    </div>
</div>

<div id="coa-print">
    <div class="coa-header">
        <div>
            <h1 style="margin:0;">SCI Pharmaceutical Industry</h1>
            <p style="margin:0;">Quality Control Department</p>
        </div>
        <div style="text-align: right;">
            <strong>A.R. NO: <span id="out_ar"></span></strong><br>
            <strong>Release Date: <span id="out_today"></span></strong>
        </div>
    </div>

    <div class="coa-title" id="out_title">CERTIFICATE OF ANALYSIS</div>

    <div class="info-box">
        <table class="info-table">
            <tr><td>Product Name</td><td id="out_name" style="font-weight:bold;"></td></tr>
            <tr class="fp-only"><td>Strength</td><td id="out_str"></td></tr>
            <tr><td>Specification</td><td id="out_spec"></td></tr>
        </table>
        <table class="info-table">
            <tr><td>Batch Number</td><td id="out_batch"></td></tr>
            <tr><td>Mfg. Date</td><td id="out_mfg"></td></tr>
            <tr><td>Exp. Date</td><td id="out_exp"></td></tr>
        </table>
    </div>

    <table class="results-table">
        <thead>
            <tr style="background:#eee !important;"><th>Test Parameter</th><th>Specification</th><th>Result</th><th>Comply</th></tr>
        </thead>
        <tbody id="out_results"></tbody>
    </table>

    <div class="footer-sig">
        <div><hr style="width:80%"><strong>Analyst</strong><br>Dr. Daoud Tajeldeinn</div>
        <div><hr style="width:80%"><strong>Checked By</strong><br>Quality Control Manager</div>
        <div><hr style="width:80%"><strong>Authorized By</strong><br>Quality Assurance</div>
    </div>
</div>

<script>
    const tests = {
        FP: [
            {t: "Description", s: "White round tablets", type: "text", target: "comply"},
            {t: "Hardness", s: "70 - 120 N", min: 70, max: 120},
            {t: "Friability", s: "NMT 1.0%", max: 1.0},
            {t: "Disintegration", s: "NMT 15 min", max: 15},
            {t: "Assay", s: "95.0 - 105.0%", min: 95, max: 105}
        ],
        RM: [
            {t: "Description", s: "White crystalline powder", type: "text", target: "comply"},
            {t: "Melting Point", s: "168 - 172°C", min: 168, max: 172},
            {t: "Loss on Drying", s: "Max 0.5%", max: 0.5},
            {t: "Assay", s: "99.0 - 101.0%", min: 99, max: 101}
        ]
    };

    const microTests = [
        {t: "TAMC", s: "NMT 10³ CFU/g"},
        {t: "TYMC", s: "NMT 10² CFU/g"},
        {t: "E. Coli", s: "Absent"}
    ];

    function switchMode() {
        const mode = document.getElementById('docMode').value;
        const fpElements = document.querySelectorAll('.fp-only');
        fpElements.forEach(el => el.style.display = (mode === 'FP' ? 'flex' : 'none'));
        
        renderTables();
        sync();
    }

    function renderTables() {
        const mode = document.getElementById('docMode').value;
        document.getElementById('chemBody').innerHTML = tests[mode].map((test, i) => `
            <tr>
                <td>${test.t}</td>
                <td style="font-size:11px;">${test.s}</td>
                <td><input type="text" class="res-input" id="chem_res_${i}" oninput="validateChem(${i})"></td>
                <td id="chem_stat_${i}">-</td>
            </tr>
        `).join('');

        document.getElementById('microBody').innerHTML = microTests.map((test, i) => `
            <tr>
                <td>${test.t}</td>
                <td>${test.s}</td>
                <td><input type="text" class="res-input" id="micro_res_${i}" oninput="sync()"></td>
                <td><select onchange="sync()"><option>Yes</option><option>No</option></select></td>
            </tr>
        `).join('');
    }

    function validateChem(i) {
        const mode = document.getElementById('docMode').value;
        const config = tests[mode][i];
        const input = document.getElementById(`chem_res_${i}`);
        const status = document.getElementById(`chem_stat_${i}`);
        const val = parseFloat(input.value);

        let pass = false;
        if (config.type === "text") {
            pass = input.value.toLowerCase().includes(config.target);
        } else {
            pass = (!config.min || val >= config.min) && (!config.max || val <= config.max);
        }

        input.className = "res-input " + (pass ? "pass" : "fail");
        status.innerText = pass ? "PASS" : "FAIL";
        status.style.color = pass ? "var(--pass)" : "var(--fail)";
        sync();
    }

    function sync() {
        // Basic Info
        document.getElementById('out_name').innerText = document.getElementById('in_name').value;
        document.getElementById('out_batch').innerText = document.getElementById('in_batch').value;
        document.getElementById('out_ar').innerText = document.getElementById('in_ar').value;
        document.getElementById('out_spec').innerText = document.getElementById('in_spec').value;
        document.getElementById('out_mfg').innerText = document.getElementById('in_mfg').value;
        document.getElementById('out_exp').innerText = document.getElementById('in_exp').value;
        document.getElementById('out_str').innerText = document.getElementById('in_str').value;
        document.getElementById('out_today').innerText = new Date().toLocaleDateString();

        const mode = document.getElementById('docMode').value;
        document.getElementById('out_title').innerText = (mode === 'FP' ? "CERTIFICATE OF ANALYSIS" : "COA - RE-ANALYSIS REPORT");

        // Results Sync
        let html = "";
        tests[mode].forEach((t, i) => {
            const val = document.getElementById(`chem_res_${i}`).value || "-";
            const stat = document.getElementById(`chem_stat_${i}`).innerText === "PASS" ? "Yes" : "No";
            html += `<tr><td>${t.t}</td><td>${t.s}</td><td>${val}</td><td>${stat}</td></tr>`;
        });
        
        // Add Micro to same table for print
        microTests.forEach((t, i) => {
            const val = document.getElementById(`micro_res_${i}`).value || "Absent";
            html += `<tr><td>${t.t}</td><td>${t.s}</td><td>${val}</td><td>Yes</td></tr>`;
        });

        document.getElementById('out_results').innerHTML = html;
    }

    window.onload = switchMode;
</script>
</body>
</html>